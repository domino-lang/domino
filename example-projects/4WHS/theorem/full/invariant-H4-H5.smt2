
(define-fun state-equality
	((state-H4 (Array Int (Maybe (Tuple11 Int Bool Int Bits_n (Maybe Bool) (Maybe Bits_n)
										  (Maybe Bits_n) (Maybe Bits_n) (Maybe Bits_n)
										  (Maybe (Tuple5 Int Int Bits_n Bits_n Bits_n)) Int))))
	 (state-H5 (Array Int (Maybe (Tuple11 Int Bool Int Bits_n (Maybe Bool) (Maybe Bits_n)
										  (Maybe Bits_n) (Maybe Bits_n) (Maybe Bits_n)
										  (Maybe (Tuple5 Int Int Bits_n Bits_n Bits_n)) Int)))))
  Bool
  (forall ((ctr Int))
		  (and (=> (= (select state-H5 ctr)
					  (as mk-none (Maybe (Tuple11 Int Bool Int Bits_n (Maybe Bool) (Maybe Bits_n)
												  (Maybe Bits_n) (Maybe Bits_n) (Maybe Bits_n)
												  (Maybe (Tuple5 Int Int Bits_n Bits_n Bits_n))
												  Int))))
				   (= (select state-H4 ctr) (select state-H5 ctr)))
			   (=> (= (select state-H4 ctr)
					  (as mk-none (Maybe (Tuple11 Int Bool Int Bits_n (Maybe Bool) (Maybe Bits_n)
												  (Maybe Bits_n) (Maybe Bits_n) (Maybe Bits_n)
												  (Maybe (Tuple5 Int Int Bits_n Bits_n Bits_n))
												  Int))))
				   (= (select state-H4 ctr) (select state-H5 ctr)))
			   (let ((state (select state-H4 ctr)))
				 (=> (not (= state
							 (as mk-none (Maybe (Tuple11 Int Bool Int Bits_n (Maybe Bool) (Maybe Bits_n)
														 (Maybe Bits_n) (Maybe Bits_n) (Maybe Bits_n)
														 (Maybe (Tuple5 Int Int Bits_n Bits_n Bits_n))
														 Int)))))

					 (let  ((U    (el11-1  (maybe-get state)))
							(u    (el11-2  (maybe-get state)))
							(V    (el11-3  (maybe-get state)))
							(ltk  (el11-4  (maybe-get state)))
							(acc  (el11-5  (maybe-get state)))
							(k    (el11-6  (maybe-get state)))
							(ni   (el11-7  (maybe-get state)))
							(nr   (el11-8  (maybe-get state)))
							(kmac (el11-9  (maybe-get state)))
							(sid  (el11-10 (maybe-get state)))
							(mess (el11-11 (maybe-get state))))
					   (= (select state-H5 ctr)
						  (mk-some (mk-tuple11 U u V ltk acc (as mk-none (Maybe Bits_n))
											   ni nr kmac sid mess)))))))))


(define-fun invariant-H4
	((state-H4 (Array Int (Maybe (Tuple11 Int Bool Int Bits_n (Maybe Bool) (Maybe Bits_n)
										  (Maybe Bits_n) (Maybe Bits_n) (Maybe Bits_n)
										  (Maybe (Tuple5 Int Int Bits_n Bits_n Bits_n)) Int)))))
  Bool
  (forall ((ctr Int))
		  (let ((state (select state-H4 ctr)))
			(=> (not (= state
						(as mk-none (Maybe (Tuple11 Int Bool Int Bits_n (Maybe Bool) (Maybe Bits_n)
													(Maybe Bits_n) (Maybe Bits_n) (Maybe Bits_n)
													(Maybe (Tuple5 Int Int Bits_n Bits_n Bits_n))
													Int)))))
				(let  ((U    (el11-1  (maybe-get state)))
					   (u    (el11-2  (maybe-get state)))
					   (V    (el11-3  (maybe-get state)))
					   (ltk  (el11-4  (maybe-get state)))
					   (acc  (el11-5  (maybe-get state)))
					   (k    (el11-6  (maybe-get state)))
					   (ni   (el11-7  (maybe-get state)))
					   (nr   (el11-8  (maybe-get state)))
					   (kmac (el11-9  (maybe-get state)))
					   (sid  (el11-10 (maybe-get state)))
					   (mess (el11-11 (maybe-get state))))
				  (and
				   (=> (> 1 mess)
					   (= k (as mk-none (Maybe Bits_n))))
				   (=> u (=> (> mess 0)
							 (and (not (= ni (as mk-none (Maybe Bits_n))))
								  (not (= nr (as mk-none (Maybe Bits_n))))
								  (not (= k (as mk-none (Maybe Bits_n)))))))
				   (=> (> mess 1)
					   (and (not (= ni (as mk-none (Maybe Bits_n))))
							(not (= nr (as mk-none (Maybe Bits_n))))
							(not (= k (as mk-none (Maybe Bits_n))))))
				   (=> (= acc (mk-some true))
					   (not (= k (as mk-none (Maybe Bits_n)))))
				   (=> (not (= k (as mk-none (Maybe Bits_n))))
					   (and (= k (mk-some (<<func-prf>> ltk (mk-tuple5 U V
														               (maybe-get ni)
														               (maybe-get nr)
														               true))))))))))))

(define-fun invariant-H5
	((state-H5 (Array Int (Maybe (Tuple11 Int Bool Int Bits_n (Maybe Bool) (Maybe Bits_n)
										  (Maybe Bits_n) (Maybe Bits_n) (Maybe Bits_n)
										  (Maybe (Tuple5 Int Int Bits_n Bits_n Bits_n)) Int)))))
  Bool
  (forall ((ctr Int))
		  (let ((state (select state-H5 ctr)))
			(=> (not (= state
						(as mk-none (Maybe (Tuple11 Int Bool Int Bits_n (Maybe Bool) (Maybe Bits_n)
													(Maybe Bits_n) (Maybe Bits_n) (Maybe Bits_n)
													(Maybe (Tuple5 Int Int Bits_n Bits_n Bits_n))
													Int)))))
				(let  ((U    (el11-1  (maybe-get state)))
					   (u    (el11-2  (maybe-get state)))
					   (V    (el11-3  (maybe-get state)))
					   (ltk  (el11-4  (maybe-get state)))
					   (acc  (el11-5  (maybe-get state)))
					   (k    (el11-6  (maybe-get state)))
					   (ni   (el11-7  (maybe-get state)))
					   (nr   (el11-8  (maybe-get state)))
					   (kmac (el11-9  (maybe-get state)))
					   (sid  (el11-10 (maybe-get state)))
					   (mess (el11-11 (maybe-get state))))
				  (and
				   (=> (= acc (mk-some true))
					   (and (not (= ni (as mk-none (Maybe Bits_n))))
							(not (= nr (as mk-none (Maybe Bits_n))))))))))))

(define-state-relation invariant
	((state-H4  <GameState_H4_<$<!n!>$>>)
	 (state-H5  <GameState_H5_<$<!n!>$>>))
  (and (= state-H4.Nonces       state-H5.Nonces)
       (= state-H4.KX.LTK       state-H5.KX.LTK)
       (= state-H4.KX.Fresh     state-H5.KX.Fresh)
       (= state-H4.KX.First     state-H5.KX.First)
       (= state-H4.KX.Second    state-H5.KX.Second)
       (= state-H4.KX.RevTested state-H5.KX.RevTested)
       (= state-H4.KX.H         state-H5.KX.H)
       (= state-H4.KX.ctr_      state-H5.KX.ctr_)
       (= state-H4.KX.kid_      state-H5.KX.kid)
	   (state-equality state-H4.KX.State
                       state-H5.KX.State)
	   (invariant-H4 state-H4.KX.State)
	   (invariant-H5 state-H5.KX.State)))
